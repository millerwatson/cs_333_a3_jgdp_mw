<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Country Well-Being Explorer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    .header {
      background: white;
      padding: 20px;
      border-bottom: 1px solid #ddd;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }

    .layout {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 84px);
    }

    .top-section {
      display: flex;
      height: 35%;
      border-bottom: 1px solid #ddd;
    }

    #map-container {
      flex: 0 0 60%;
      position: relative;
      border-right: 1px solid #ddd;
      background: white;
    }

    #map-container svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .country {
      stroke: #333;
      stroke-width: 0.5;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .country:hover {
      opacity: 0.7;
      stroke-width: 1.5;
    }

    .country.selected {
      stroke: #000;
      stroke-width: 2;
    }

    #controls {
      flex: 0 0 280px;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      background: white;
      border-right: 1px solid #ddd;
    }

    #controls h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #333;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #555;
    }

    .control-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }

    #charts-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f5f5f5;
    }

    .chart-panel {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }

    .chart-panel h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .no-selection {
      text-align: center;
      color: #999;
      padding: 40px;
      font-size: 14px;
    }

    .tooltip {
      position: absolute;
      background: white;
      padding: 8px 12px;
      border: 1px solid #999;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.15s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .legend {
      font-size: 11px;
      margin-top: 20px;
    }

    .legend-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Country Well-Being Explorer</h1>
  </div>

  <div class="layout">
    <div class="top-section">
      <!-- Map -->
      <div id="map-container">
        <svg></svg>
      </div>

      <!-- Control Panel -->
      <div id="controls">
        <h3>Color Map</h3>
        <div class="control-group">
          <select id="metric-select">
            <option value="Thriving Index">Thriving Index</option>
            <option value="Health Index">Health Index</option>
            <option value="Balance in Life">Balance in Life</option>
            <option value="Enjoy Work">Enjoy Work</option>
            <option value="Work Freedom">Work Freedom</option>
          </select>
        </div>

        <div class="legend">
          <div class="legend-title">Legend</div>
          <svg id="legend-svg" width="240" height="60"></svg>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div id="charts-container">
      <div class="no-selection">
        Click on a country to view demographic breakdowns
      </div>
    </div>
  </div>

  <div class="tooltip"></div>

  <script>
    // CSV filename to load
    const CSV_FILENAME = "data/better_wellbeing.csv";

    const mapContainer = document.getElementById("map-container");
    const width = mapContainer.clientWidth;
    const height = mapContainer.clientHeight;

    const svg = d3.select("#map-container svg");
    const tooltip = d3.select(".tooltip");

    const projection = d3.geoMercator()
      .scale(100)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    const g = svg.append("g");

    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .translateExtent([[0, 0], [width, height]])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    svg.call(zoom);

    let data = [];
    let selectedCountry = null;
    let currentMetric = "Thriving Index";
    let metricColumnsMap = {}; // Will be populated after we parse headers

    // Normalize country names
    function normalize(name) {
      if (!name) return "";
      return name
        .toLowerCase()
        .replace(/,/g, "")
        .replace(/\./g, "")
        .replace(/the\s+/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    // Parse percentage strings
    function parsePercentage(str) {
      if (!str || str === "" || str === " ") return null;
      const num = parseFloat(str.replace('%', ''));
      return isNaN(num) ? null : num;
    }

    // Load data
    Promise.all([
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
      d3.text(CSV_FILENAME)
    ]).then(([worldData, csvText]) => {
      // Parse CSV manually to handle the multi-row header
      const lines = csvText.split('\n');
      
      // Get the header rows
      const headerRow1 = lines[0].split(','); // Question names
      const headerRow2 = lines[1].split(','); // Response options (Yes, No, etc.)
      
      // Create combined column names
      const columnNames = headerRow1.map((q, i) => {
        if (i < 3) return ['Country', 'Demographic', 'Value'][i]; // First 3 columns
        const question = q.trim();
        const response = headerRow2[i] ? headerRow2[i].trim() : '';
        if (question && response && response !== 'Rate') {
          return `${question}_${response}`;
        }
        return question || `col_${i}`;
      });
      
      console.log('Column names:', columnNames);
      
      // Now set up the metric columns mapping based on what we found
      metricColumnsMap = {
        "Thriving Index": "Thriving Index",
        "Health Index": "Health Problems_Yes", // Will invert this (100 - value)
        "Balance in Life": "Various Aspects of Life in Balance_Yes",
        "Enjoy Work": "Enjoy the Work You Do Every Day_Yes",
        "Work Freedom": "Many Choices in Type of Work_Yes"
      };
      
      // Skip the first 3 rows (headers) and parse data rows
      data = lines.slice(3)
        .filter(line => line.trim() !== '')
        .map(line => {
          const values = line.split(',');
          const row = {
            Country: values[0],
            Demographic_Type: values[1],
            Demographic_Value: values[2]
          };
          
          // Add all the metric columns
          columnNames.forEach((colName, i) => {
            if (i >= 3) {
              row[colName] = parsePercentage(values[i]);
            }
          });
          
          return row;
        })
        .filter(d => d.Country && d.Country.trim() !== '');

      console.log('Loaded data rows:', data.length);
      console.log('Sample data:', data.slice(0, 3));
      console.log('Available metrics:', Object.keys(data[0]).filter(k => !['Country', 'Demographic_Type', 'Demographic_Value'].includes(k)));
      console.log('Metric columns mapping:', metricColumnsMap);

      // Calculate average metric values per country for map coloring
      const csvMetric = metricColumnsMap[currentMetric];
      const countryMetrics = d3.rollup(
        data,
        v => {
          const values = v.map(d => d[csvMetric]).filter(val => val !== null && !isNaN(val));
          if (values.length === 0) return null;
          const avg = d3.mean(values);
          // Invert Health Problems to make it Health Index
          return currentMetric === "Health Index" ? 100 - avg : avg;
        },
        d => d.Country
      );

      console.log('Country metrics:', Array.from(countryMetrics.entries()).slice(0, 5));

      const values = [...countryMetrics.values()].filter(v => v !== null && !isNaN(v));
      const colorScale = d3.scaleSequential(d3.interpolateBlues)
        .domain([d3.min(values), d3.max(values)]);

      // Draw legend
      drawLegend(colorScale, d3.min(values), d3.max(values));

      // Draw map
      const countries = topojson.feature(worldData, worldData.objects.countries);

      g.selectAll("path")
        .data(countries.features)
        .enter()
        .append("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("fill", d => {
          const cname = d.properties.name;
          const value = countryMetrics.get(cname);
          return value != null && !isNaN(value) ? colorScale(value) : "#e0e0e0";
        })
        .on("click", function(event, d) {
          const countryName = d.properties.name;
          
          // Remove previous selection
          g.selectAll("path").classed("selected", false);
          
          // Add selection to clicked country
          d3.select(this).classed("selected", true);
          
          selectedCountry = countryName;
          drawCharts(countryName);
        })
        .on("mouseover", function(event, d) {
          const cname = d.properties.name;
          const value = countryMetrics.get(cname);
          
          tooltip
            .style("opacity", 1)
            .html(
              `<strong>${cname}</strong><br>` +
              (value != null && !isNaN(value) ? `${currentMetric}: ${value.toFixed(1)}%` : "No data")
            );
        })
        .on("mousemove", event => {
          tooltip
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY + 10 + "px");
        })
        .on("mouseout", function() {
          tooltip.style("opacity", 0);
        });
    });

    function drawLegend(colorScale, min, max) {
      const legendSvg = d3.select("#legend-svg");
      legendSvg.selectAll("*").remove();

      const legendWidth = 200;
      const legendHeight = 12;

      const defs = legendSvg.append("defs");
      const gradient = defs.append("linearGradient")
        .attr("id", "legend-gradient")
        .attr("x1", "0%")
        .attr("x2", "100%");

      gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", colorScale(min));

      gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", colorScale(max));

      legendSvg.append("rect")
        .attr("x", 20)
        .attr("y", 10)
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .style("fill", "url(#legend-gradient)")
        .style("stroke", "#333")
        .style("stroke-width", 0.5);

      const scale = d3.scaleLinear()
        .domain([min, max])
        .range([20, 20 + legendWidth]);

      const axis = d3.axisBottom(scale)
        .ticks(5)
        .tickSize(4);

      legendSvg.append("g")
        .attr("transform", `translate(0, ${10 + legendHeight})`)
        .call(axis)
        .style("font-size", "10px");
    }

    function drawCharts(countryName) {
      const container = d3.select("#charts-container");
      container.html("");

      // Filter data for selected country
      const countryData = data.filter(d => d.Country === countryName);

      if (countryData.length === 0) {
        container.append("div")
          .attr("class", "no-selection")
          .text(`No data available for ${countryName}`);
        return;
      }

      // Get unique demographic types
      const demographicTypes = [...new Set(countryData.map(d => d.Demographic_Type))];

      // Create a chart for each demographic type
      demographicTypes.forEach(demType => {
        const demData = countryData.filter(d => d.Demographic_Type === demType);

        const panel = container.append("div")
          .attr("class", "chart-panel");

        panel.append("h3")
          .text(`${countryName} - ${demType}`);

        const chartSvg = panel.append("svg")
          .attr("id", `chart-${demType.replace(/\s+/g, '-')}`);

        drawBarChart(chartSvg, demData, demType);
      });
    }

    function drawBarChart(svg, chartData, demographicType) {
      const margin = { top: 15, right: 15, bottom: 60, left: 50 };
      const width = 500 - margin.left - margin.right;
      const height = 220 - margin.top - margin.bottom;

      svg
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // Get the CSV metric column name
      const csvMetric = metricColumnsMap[currentMetric];
      
      // Process data and invert Health Problems if needed
      const processedData = chartData.map(d => ({
        ...d,
        value: currentMetric === "Health Index" ? 100 - d[csvMetric] : d[csvMetric]
      })).filter(d => d.value !== null && !isNaN(d.value));

      if (processedData.length === 0) {
        g.append("text")
          .attr("x", width / 2)
          .attr("y", height / 2)
          .attr("text-anchor", "middle")
          .style("fill", "#999")
          .text("No data available for this metric");
        return;
      }

      // Scales
      const x = d3.scaleBand()
        .domain(processedData.map(d => d.Demographic_Value))
        .range([0, width])
        .padding(0.3);

      const y = d3.scaleLinear()
        .domain([0, 100])
        .range([height, 0]);

      // X axis
      g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .style("font-size", "10px");

      // Y axis
      g.append("g")
        .call(d3.axisLeft(y).ticks(5).tickFormat(d => d + "%"))
        .style("font-size", "10px");

      // Bars
      g.selectAll(".bar")
        .data(processedData)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.Demographic_Value))
        .attr("y", d => y(d.value))
        .attr("width", x.bandwidth())
        .attr("height", d => height - y(d.value))
        .attr("fill", "#4f46e5")
        .attr("opacity", 0.8)
        .on("mouseover", function(event, d) {
          d3.select(this).attr("opacity", 1);

          tooltip
            .style("opacity", 1)
            .html(
              `<strong>${d.Demographic_Value}</strong><br>` +
              `${currentMetric}: ${d.value.toFixed(1)}%`
            );
        })
        .on("mousemove", event => {
          tooltip
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY + 10 + "px");
        })
        .on("mouseout", function() {
          d3.select(this).attr("opacity", 0.8);
          tooltip.style("opacity", 0);
        });

      // Value labels
      g.selectAll(".label")
        .data(processedData)
        .enter()
        .append("text")
        .attr("class", "label")
        .attr("x", d => x(d.Demographic_Value) + x.bandwidth() / 2)
        .attr("y", d => y(d.value) - 3)
        .attr("text-anchor", "middle")
        .style("font-size", "9px")
        .style("fill", "#333")
        .text(d => d.value.toFixed(1) + "%");
    }

    // Metric selector (not functional yet, as requested)
    document.getElementById("metric-select").addEventListener("change", function() {
      currentMetric = this.value;
      // Will implement functionality in next step
    });
  </script>
</body>
</html>